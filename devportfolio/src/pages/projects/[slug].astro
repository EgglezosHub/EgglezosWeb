---
import { siteConfig } from "../../config";
import "../../styles/global.css";

// Build routes: /projects/<slug>
export function getStaticPaths() {
  return (siteConfig.projects ?? [])
    .filter((p) => p.slug)
    .map((p) => ({ params: { slug: p.slug } }));
}

// ⚡ Minimal markdown-to-HTML (bold only) for inline paragraphs
const mdBold = (s: string) => s.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");

const { slug } = Astro.params;
const project = siteConfig.projects?.find((p) => p.slug === slug);
if (!project) {
  throw new Error(`Project with slug "${slug}" not found. Add 'slug' to siteConfig.projects.`);
}
---


<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{project.name} — {siteConfig.name}</title>
    <meta name="description" content={project.description} />
  </head>
  <body class="bg-white text-gray-800">
    <section class="relative isolate overflow-hidden py-16 md:py-24">
      <div class="absolute inset-0 -z-10 opacity-40"
        style={`background: radial-gradient(ellipse 800px 1200px at 0% 0%, ${siteConfig.accentColor}40 0%, ${siteConfig.accentColor}25 20%, ${siteConfig.accentColor}10 40%, rgba(255,255,255,0.3) 70%, rgba(255,255,255,0.85) 90%, white 100%)`}>
      </div>

      <div class="max-w-5xl mx-auto px-6 md:px-12">
        <a href="/" class="inline-flex items-center gap-2 text-sm font-medium hover:underline" style={`color:${siteConfig.accentColor}`}>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
          Back to home
        </a>

        <h1 class="mt-6 text-3xl sm:text-4xl md:text-5xl font-extrabold text-gray-900">{project.name}</h1>
        <p class="mt-3 text-base sm:text-lg md:text-xl text-gray-600">{project.description}</p>
        {project.dateRange && <p class="mt-2 text-sm text-gray-500">{project.dateRange}</p>}

        {project.skills?.length > 0 && (
          <div class="mt-6 flex flex-wrap gap-2">
            {project.skills.map((s) => (
              <span class="px-3 py-1 bg-gray-900 text-white rounded-md text-xs sm:text-sm">{s}</span>
            ))}
          </div>
        )}

        {(project.repo || project.demo || project.link) && (
          <div class="mt-6 flex flex-wrap gap-3">
            {project.repo && (
              <a href={project.repo} target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border text-sm font-medium hover:shadow transition"
                 style={`border-color:${siteConfig.accentColor}; color:${siteConfig.accentColor}`}>
                View Repo
              </a>
            )}
            {project.demo && (
              <a href={project.demo} target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-white text-sm font-medium hover:shadow transition"
                 style={`background:${siteConfig.accentColor}`}>
                Live Demo
              </a>
            )}
            {!project.demo && project.link && (
              <a href={project.link} target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-white text-sm font-medium hover:shadow transition"
                 style={`background:${siteConfig.accentColor}`}>
                Open Link
              </a>
            )}
          </div>
        )}

        <div class="mt-12 grid grid-cols-1 md:grid-cols-12 gap-8">
          <div class="md:col-span-8 space-y-8">
            {project.overview && (
              <section>
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-900">Overview</h2>
                <p class="mt-2 text-gray-700 leading-relaxed">{project.overview}</p>
              </section>
            )}

            {project.highlights?.length > 0 && (
              <section>
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-900">Highlights</h2>
                <ul class="mt-3 space-y-2">
                  {project.highlights.map((h) => (
                    <li class="flex items-start text-gray-700">
                      <span class="inline-block w-1.5 h-1.5 rounded-full bg-gray-400 mt-2 mr-3" />{h}
                    </li>
                  ))}
                </ul>
              </section>
            )}

            {project.performance?.length > 0 && (
              <section>
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-900">Performance & Results (Full Report)</h2>
                <div class="mt-3 space-y-6">
                  {project.performance.map((p) => (
                    <p class="text-gray-700 leading-relaxed" set:html={mdBold(p)} />
                  ))}
                </div>
              </section>
            )}

            {project.images?.length > 0 && (
              <section>
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-900">Gallery</h2>
                <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                  {project.images.map((src, i) => (
                    <button
                      type="button"
                      class="rounded-lg overflow-hidden border border-gray-200 hover:shadow-lg transition focus:outline-none focus:ring-2 focus:ring-offset-2"
                      style={`--ring-color:${siteConfig.accentColor}`}
                      data-lb-index={i}
                      data-lb-src={src}
                    >
                      <img src={src} alt={`${project.name} screenshot ${i+1}`} class="w-full h-auto object-cover" loading="lazy" />
                    </button>
                  ))}
                </div>
              </section>
            )}

            {project.challenges?.length > 0 && (
              <section>
                <h2 class="text-xl sm:text-2xl font-semibold text-gray-900">Challenges & Learnings</h2>
                <ul class="mt-3 space-y-2">
                  {project.challenges.map((c) => (
                    <li class="flex items-start text-gray-700">
                      <span class="inline-block w-1.5 h-1.5 rounded-full bg-gray-400 mt-2 mr-3" />{c}
                    </li>
                  ))}
                </ul>
              </section>
            )}
          </div>

          <aside class="md:col-span-4 space-y-6">
            {project.tech?.length > 0 && (
              <div class="bg-gray-50 border border-gray-200 rounded-xl p-5">
                <h3 class="text-lg font-semibold text-gray-900">Tech Stack</h3>
                <div class="mt-3 flex flex-wrap gap-2">
                  {project.tech.map((t) => (
                    <span class="px-2.5 py-1 bg-gray-900 text-white rounded-md text-xs">{t}</span>
                  ))}
                </div>
              </div>
            )}
          </aside>
        </div>
      </div>
    </section>
    <!-- Lightbox overlay -->
    <div id="lightbox"
        class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm p-4 md:p-8 flex items-center justify-center">
      <!-- Close -->
      <button id="lb-close"
              class="absolute top-4 right-4 md:top-6 md:right-6 text-white/90 text-3xl leading-none px-3 py-1 rounded hover:bg-white/10"
              aria-label="Close">×</button>

      <!-- Prev -->
      <button id="lb-prev"
              class="absolute left-3 md:left-6 text-white/90 text-2xl px-3 py-2 rounded hover:bg-white/10"
              aria-label="Previous">‹</button>

      <!-- Next -->
      <button id="lb-next"
              class="absolute right-3 md:right-6 text-white/90 text-2xl px-3 py-2 rounded hover:bg-white/10"
              aria-label="Next">›</button>

      <!-- Image -->
      <img id="lb-img"
          class="max-w-[90vw] max-h-[85vh] rounded-lg shadow-2xl border border-white/20 object-contain"
          alt="Project image" />
    </div>

    <script type="module">
      // Collect all clickable thumbs
      const thumbs = Array.from(document.querySelectorAll('[data-lb-index]'));
      if (thumbs.length) {
        const overlay = document.getElementById('lightbox');
        const imgEl   = document.getElementById('lb-img');
        const btnClose = document.getElementById('lb-close');
        const btnPrev  = document.getElementById('lb-prev');
        const btnNext  = document.getElementById('lb-next');

        let idx = 0;

        const open = (i) => {
          idx = i;
          imgEl.src = thumbs[idx].dataset.lbSrc;
          overlay.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        };

        const close = () => {
          overlay.classList.add('hidden');
          document.body.style.overflow = '';
          imgEl.src = '';
        };

        const prev = () => open((idx - 1 + thumbs.length) % thumbs.length);
        const next = () => open((idx + 1) % thumbs.length);

        thumbs.forEach((t) => t.addEventListener('click', () => open(Number(t.dataset.lbIndex))));
        btnClose.addEventListener('click', close);
        btnPrev.addEventListener('click', prev);
        btnNext.addEventListener('click', next);

        // Close on backdrop click
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) close();
        });

        // Keyboard controls
        window.addEventListener('keydown', (e) => {
          if (overlay.classList.contains('hidden')) return;
          if (e.key === 'Escape') close();
          if (e.key === 'ArrowLeft') prev();
          if (e.key === 'ArrowRight') next();
        });
      }
    </script>

  </body>
</html>
